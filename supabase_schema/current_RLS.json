[
  {
    "table_schema": "public",
    "table_name": "book_loans",
    "policyname": "Admins can update loans",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "UPDATE",
    "qual": "(is_super_admin() OR is_admin() OR (auth.uid() = lender_id) OR (auth.uid() = borrower_id))",
    "with_check": "(is_super_admin() OR is_admin() OR (auth.uid() = lender_id) OR (auth.uid() = borrower_id))"
  },
  {
    "table_schema": "public",
    "table_name": "book_loans",
    "policyname": "Allow borrower or lender to read",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "SELECT",
    "qual": "(is_super_admin() OR is_admin() OR (auth.uid() = lender_id) OR (auth.uid() = borrower_id))",
    "with_check": null
  },
  {
    "table_schema": "public",
    "table_name": "book_requests",
    "policyname": "Users can delete their own requests",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "DELETE",
    "qual": "(is_super_admin() OR (auth.uid() = requested_by))",
    "with_check": null
  },
  {
    "table_schema": "public",
    "table_name": "book_requests",
    "policyname": "Users can request books",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "INSERT",
    "qual": null,
    "with_check": "(is_super_admin() OR ((auth.uid() = requested_by) AND (requested_by <> requested_to) AND (requested_to = ( SELECT b.user_id\n   FROM books b\n  WHERE (b.id = book_requests.book_id)))))"
  },
  {
    "table_schema": "public",
    "table_name": "book_requests",
    "policyname": "Users can update relevant requests",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "UPDATE",
    "qual": "((auth.uid() = requested_by) OR (auth.uid() = requested_to))",
    "with_check": "(is_super_admin() OR (((auth.uid() = requested_by) OR (auth.uid() = requested_to) OR is_admin()) AND (requested_by <> requested_to) AND (requested_to = ( SELECT b.user_id\n   FROM books b\n  WHERE (b.id = book_requests.book_id)))))"
  },
  {
    "table_schema": "public",
    "table_name": "book_requests",
    "policyname": "Users can view their book requests",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "SELECT",
    "qual": "(is_super_admin() OR is_admin() OR (auth.uid() = requested_by) OR (auth.uid() = requested_to))",
    "with_check": null
  },
  {
    "table_schema": "public",
    "table_name": "book_reviews",
    "policyname": "Anyone can view book reviews",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "SELECT",
    "qual": "true",
    "with_check": null
  },
  {
    "table_schema": "public",
    "table_name": "book_reviews",
    "policyname": "Users can insert their own book reviews",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "INSERT",
    "qual": null,
    "with_check": "(is_super_admin() OR ((auth.uid() = reviewer_id) AND (EXISTS ( SELECT 1\n   FROM books b\n  WHERE ((b.id = book_reviews.book_id) AND (b.user_id <> auth.uid()))))))"
  },
  {
    "table_schema": "public",
    "table_name": "book_reviews",
    "policyname": "book_reviews_delete_own",
    "permissive": "PERMISSIVE",
    "roles": "{authenticated}",
    "cmd": "DELETE",
    "qual": "(is_super_admin() OR is_admin() OR (reviewer_id = auth.uid()))",
    "with_check": null
  },
  {
    "table_schema": "public",
    "table_name": "book_reviews",
    "policyname": "book_reviews_insert_non_owner",
    "permissive": "PERMISSIVE",
    "roles": "{authenticated}",
    "cmd": "INSERT",
    "qual": null,
    "with_check": "((reviewer_id = auth.uid()) AND (EXISTS ( SELECT 1\n   FROM books b\n  WHERE ((b.id = book_reviews.book_id) AND (b.user_id <> auth.uid())))))"
  },
  {
    "table_schema": "public",
    "table_name": "book_reviews",
    "policyname": "book_reviews_select_all",
    "permissive": "PERMISSIVE",
    "roles": "{authenticated}",
    "cmd": "SELECT",
    "qual": "(is_super_admin() OR is_admin() OR true)",
    "with_check": null
  },
  {
    "table_schema": "public",
    "table_name": "book_reviews",
    "policyname": "book_reviews_update_own",
    "permissive": "PERMISSIVE",
    "roles": "{authenticated}",
    "cmd": "UPDATE",
    "qual": "(reviewer_id = auth.uid())",
    "with_check": "(is_super_admin() OR is_admin() OR (reviewer_id = auth.uid()))"
  },
  {
    "table_schema": "public",
    "table_name": "books",
    "policyname": "Anyone can view available books",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "SELECT",
    "qual": "(is_super_admin() OR is_admin() OR (archived = false))",
    "with_check": null
  },
  {
    "table_schema": "public",
    "table_name": "books",
    "policyname": "Users can manage their own books",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "ALL",
    "qual": "(is_super_admin() OR is_admin() OR (auth.uid() = user_id))",
    "with_check": "(is_super_admin() OR is_admin() OR (auth.uid() = user_id))"
  },
  {
    "table_schema": "public",
    "table_name": "books_catalog",
    "policyname": "Users can insert catalog entries",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "INSERT",
    "qual": null,
    "with_check": "((created_by IS NULL) OR (auth.uid() = created_by))"
  },
  {
    "table_schema": "public",
    "table_name": "books_catalog",
    "policyname": "Users can view catalog entries",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "SELECT",
    "qual": "true",
    "with_check": null
  },
  {
    "table_schema": "public",
    "table_name": "profiles",
    "policyname": "Users can delete their own profile",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "DELETE",
    "qual": "(is_super_admin() OR is_admin() OR (auth.uid() = id))",
    "with_check": null
  },
  {
    "table_schema": "public",
    "table_name": "profiles",
    "policyname": "Users can insert their own profile",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "INSERT",
    "qual": null,
    "with_check": "(is_super_admin() OR is_admin() OR ((auth.uid() = id) AND (approval_status = 'pending'::text)))"
  },
  {
    "table_schema": "public",
    "table_name": "profiles",
    "policyname": "Users can update their own profile",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "UPDATE",
    "qual": "((auth.uid() = id) OR is_admin() OR is_super_admin())",
    "with_check": "(is_super_admin() OR is_admin() OR ((auth.uid() = id) AND (approval_status = ( SELECT p.approval_status\n   FROM profiles p\n  WHERE (p.id = auth.uid())))))"
  },
  {
    "table_schema": "public",
    "table_name": "profiles",
    "policyname": "Users can view their own profile",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "SELECT",
    "qual": "(is_super_admin() OR is_admin() OR (auth.uid() = id))",
    "with_check": null
  },
  {
    "table_schema": "public",
    "table_name": "return_requests",
    "policyname": "Borrower or lender can read return requests",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "SELECT",
    "qual": "(is_super_admin() OR is_admin() OR (auth.uid() = requested_by) OR (auth.uid() IN ( SELECT bl.lender_id\n   FROM book_loans bl\n  WHERE (bl.id = return_requests.loan_id))))",
    "with_check": null
  },
  {
    "table_schema": "public",
    "table_name": "return_requests",
    "policyname": "Borrower or lender can request return",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "INSERT",
    "qual": null,
    "with_check": "(is_super_admin() OR ((auth.uid() = requested_by) AND ((auth.uid() IN ( SELECT bl.borrower_id\n   FROM book_loans bl\n  WHERE (bl.id = return_requests.loan_id))) OR (auth.uid() IN ( SELECT bl.lender_id\n   FROM book_loans bl\n  WHERE (bl.id = return_requests.loan_id))))))"
  },
  {
    "table_schema": "public",
    "table_name": "return_requests",
    "policyname": "Only lender can update return status",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "UPDATE",
    "qual": "(auth.uid() IN ( SELECT book_loans.lender_id\n   FROM book_loans\n  WHERE (book_loans.id = return_requests.loan_id)))",
    "with_check": "(is_super_admin() OR is_admin() OR (auth.uid() IN ( SELECT bl.lender_id\n   FROM book_loans bl\n  WHERE (bl.id = return_requests.loan_id))))"
  },
  {
    "table_schema": "public",
    "table_name": "saved_books",
    "policyname": "Can save books for self",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "INSERT",
    "qual": null,
    "with_check": "(is_super_admin() OR (auth.uid() = user_id))"
  },
  {
    "table_schema": "public",
    "table_name": "saved_books",
    "policyname": "Can unsave own books",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "DELETE",
    "qual": "(is_super_admin() OR (auth.uid() = user_id))",
    "with_check": null
  },
  {
    "table_schema": "public",
    "table_name": "saved_books",
    "policyname": "Can view own saved books",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "SELECT",
    "qual": "(is_super_admin() OR is_admin() OR (auth.uid() = user_id))",
    "with_check": null
  },
  {
    "table_schema": "public",
    "table_name": "saved_books",
    "policyname": "Users can remove their saved books",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "DELETE",
    "qual": "(is_super_admin() OR (auth.uid() = user_id))",
    "with_check": null
  },
  {
    "table_schema": "public",
    "table_name": "saved_books",
    "policyname": "Users can save books for themselves",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "INSERT",
    "qual": null,
    "with_check": "(is_super_admin() OR (auth.uid() = user_id))"
  },
  {
    "table_schema": "public",
    "table_name": "saved_books",
    "policyname": "Users can view their saved books",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "SELECT",
    "qual": "(is_super_admin() OR is_admin() OR (auth.uid() = user_id))",
    "with_check": null
  },
  {
    "table_schema": "public",
    "table_name": "transfers",
    "policyname": "Only involved users can insert transfer",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "INSERT",
    "qual": null,
    "with_check": "(is_super_admin() OR (((auth.uid() = from_user) OR (auth.uid() = to_user)) AND (EXISTS ( SELECT 1\n   FROM book_requests br\n  WHERE ((br.id = transfers.request_id) AND (br.book_id = transfers.book_id) AND (br.requested_by = transfers.to_user) AND (br.requested_to = transfers.from_user) AND (br.status = 'accepted'::text))))))"
  },
  {
    "table_schema": "public",
    "table_name": "transfers",
    "policyname": "Only involved users can update transfer",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "UPDATE",
    "qual": "((auth.uid() = from_user) OR (auth.uid() = to_user))",
    "with_check": "(is_super_admin() OR (((auth.uid() = from_user) OR (auth.uid() = to_user) OR is_admin()) AND (EXISTS ( SELECT 1\n   FROM book_requests br\n  WHERE ((br.id = transfers.request_id) AND (br.book_id = transfers.book_id) AND (br.requested_by = transfers.to_user) AND (br.requested_to = transfers.from_user))))))"
  },
  {
    "table_schema": "public",
    "table_name": "transfers",
    "policyname": "Users involved in transfer can view",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "SELECT",
    "qual": "(is_super_admin() OR is_admin() OR (auth.uid() = from_user) OR (auth.uid() = to_user))",
    "with_check": null
  },
  {
    "table_schema": "public",
    "table_name": "user_reviews",
    "policyname": "Reviewer and reviewee can view the review",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "SELECT",
    "qual": "(is_super_admin() OR is_admin() OR (auth.uid() = reviewer_id) OR (auth.uid() = reviewee_id))",
    "with_check": null
  },
  {
    "table_schema": "public",
    "table_name": "user_reviews",
    "policyname": "Users can review other users",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "INSERT",
    "qual": null,
    "with_check": "(is_super_admin() OR ((auth.uid() = reviewer_id) AND (reviewer_id <> reviewee_id) AND (EXISTS ( SELECT 1\n   FROM profiles p\n  WHERE (p.id = user_reviews.reviewee_id)))))"
  },
  {
    "table_schema": "storage",
    "table_name": "objects",
    "policyname": "Allow authenticated upload",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "INSERT",
    "qual": null,
    "with_check": "(auth.role() = 'authenticated'::text)"
  },
  {
    "table_schema": "storage",
    "table_name": "objects",
    "policyname": "Allow public read",
    "permissive": "PERMISSIVE",
    "roles": "{public}",
    "cmd": "SELECT",
    "qual": "true",
    "with_check": null
  }
]
